# K 线生成引擎设计 (K-Line Engine)

## 1. 设计背景
因子计算（如 MA, RSI, MACD）通常基于特定周期的 K 线（Bar）。该引擎负责将离散的 Tick 聚合为连续的时序数据。

## 2. 核心逻辑

### 2.1 聚合算法 (OHLCV)
对于每个周期（如 1 分钟），维护当前 Bar 的状态：
- **Open**: 该周期内第一个 Tick 的价格。
- **High**: 该周期内最高价格。
- **Low**: 该周期内最低价格。
- **Close**: 该周期内最后一个 Tick 的价格。
- **Volume**: 该周期内成交量的累加。

### 2.2 多周期并发生成
引擎支持同时生成多个周期：
- **Level 1**: 1-Minute Bar (基础)。
- **Level 2**: 基于 1-Minute Bar 聚合 5-Min, 15-Min, 1-Hour Bar。
- **Level 3**: 日线及以上级别。

## 3. 架构集成
- **输入**: 订阅 `EVENT_MARKET_DATA` 或通过 `DataFeed` 读取 `mmap`。
- **输出**: 发布 `EVENT_KLINE_UPDATE` 事件到总线。
- **状态存储**: 维护最近 N 根 K 线在内存中，以便因子插件快速访问。

## 4. 关键挑战：对齐与闭合
- **对齐**: 严格按照交易所时间戳（而非本地时间）对齐。
- **闭合**: 在收到下一分钟第一个 Tick 时，发出上一分钟 Bar 的“闭合”信号，触发强一致性的因子计算。
